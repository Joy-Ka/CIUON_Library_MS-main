{% extends "base.html" %}

{% block title %}Dashboard - Confucius Institute Library{% endblock %}

{% block page_header %}Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen" style="background-image: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('/static/images/background.jpg'); background-size: cover; background-position: center; background-attachment: fixed;">
    <div class="max-w-7xl mx-auto">

        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800">Welcome to the Library System</h2>
            <p class="text-gray-600 mt-2 text-lg">Quick overview of your library statistics</p>
        </div>

        <!-- Statistics Cards with Enhanced Visibility -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-xl p-8 text-white transform transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-red-100 text-lg font-bold mb-3 uppercase tracking-wide">Students</div>
                        <div class="text-5xl font-extrabold mb-2">{{ total_students }}</div>
                        <div class="text-red-100 text-sm font-medium">Total Registered</div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-xl p-4">
                        <i class="bi bi-people text-5xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-xl p-8 text-white transform transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-green-100 text-lg font-bold mb-3 uppercase tracking-wide">Staff</div>
                        <div class="text-5xl font-extrabold mb-2">{{ total_staff }}</div>
                        <div class="text-green-100 text-sm font-medium">Active Members</div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-xl p-4">
                        <i class="bi bi-person-badge text-5xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-xl p-8 text-white transform transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-blue-100 text-lg font-bold mb-3 uppercase tracking-wide">Books</div>
                        <div class="text-5xl font-extrabold mb-2">{{ total_books }}</div>
                        <div class="text-blue-100 text-sm font-medium">In Collection</div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-xl p-4">
                        <i class="bi bi-journal-bookmark text-5xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl shadow-xl p-8 text-white transform transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-amber-100 text-lg font-bold mb-3 uppercase tracking-wide">Active Borrows</div>
                        <div class="text-5xl font-extrabold mb-2">{{ active_borrows }}</div>
                        <div class="text-amber-100 text-sm font-medium">Currently Out</div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-xl p-4">
                        <i class="bi bi-arrow-left-right text-5xl"></i>
                    </div>
                </div>
            </div>
        </div>

        {% if current_user.role == 'admin' %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-xl shadow-xl p-8 text-white transform transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-rose-100 text-lg font-bold mb-3 uppercase tracking-wide">Total Unpaid Fines</div>
                        <div class="text-5xl font-extrabold mb-2">KES {{ "%.2f"|format(total_fines) }}</div>
                        <div class="text-rose-100 text-sm font-medium">Outstanding Amount</div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-xl p-4">
                        <i class="bi bi-exclamation-triangle text-5xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-gray-600 to-gray-700 rounded-xl shadow-xl p-8 text-white transform transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-gray-100 text-lg font-bold mb-3 uppercase tracking-wide">Overdue Books</div>
                        <div class="text-5xl font-extrabold mb-2">{{ overdue_books|length }}</div>
                        <div class="text-gray-100 text-sm font-medium">Require Attention</div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-xl p-4">
                        <i class="bi bi-clock text-5xl"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
                <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-5">
                    <h5 class="text-white font-bold text-xl flex items-center gap-3">
                        <i class="bi bi-clock-history text-2xl"></i>
                        <span>Recent Borrowing Activity</span>
                    </h5>
                </div>
                <div class="p-6">
                    {% if recent_borrows %}
                    <div class="space-y-4">
                        {% for borrow in recent_borrows %}
                        <div class="border-l-4 border-red-500 pl-5 py-3 hover:bg-gray-50 transition rounded-r-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h6 class="font-bold text-gray-900 text-lg">{{ borrow.book_ref.title }}</h6>
                                <small class="text-gray-600 font-medium text-sm">{{ borrow.borrowed_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                            <p class="text-base text-gray-700 mb-2 font-medium">
                                <strong class="text-red-600">{{ borrow.borrower_type }}:</strong> {{ borrow.borrower_name }}
                            </p>
                            <small class="text-gray-600 font-medium">Due: {{ borrow.due_date.strftime('%Y-%m-%d') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-lg">No recent borrowing activity</p>
                    {% endif %}
                </div>
            </div>

            {% if overdue_books %}
            <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
                <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-5">
                    <h5 class="text-white font-bold text-xl flex items-center gap-3">
                        <i class="bi bi-exclamation-triangle text-2xl"></i>
                        <span>Overdue Books</span>
                    </h5>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        {% for borrow in overdue_books[:5] %}
                        <div class="border-l-4 border-rose-500 pl-5 py-3 hover:bg-gray-50 transition rounded-r-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h6 class="font-bold text-gray-900 text-lg">{{ borrow.book_ref.title }}</h6>
                                <small class="text-red-600 font-bold text-sm bg-red-50 px-3 py-1 rounded-full">{{ borrow.days_overdue }} days overdue</small>
                            </div>
                            <p class="text-base text-gray-700 mb-2 font-medium">
                                <strong class="text-red-600">{{ borrow.borrower_type }}:</strong> {{ borrow.borrower_name }}
                            </p>
                            <small class="text-gray-600 font-medium">Due: {{ borrow.due_date.strftime('%Y-%m-%d') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% if overdue_books|length > 5 %}
                    <div class="text-center mt-5">
                        <a href="{{ url_for('reports.overdue_items') }}" class="inline-block px-6 py-3 border-2 border-red-600 text-red-600 font-bold rounded-lg hover:bg-red-50 transition text-base">
                            View All Overdue Items
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-5">
                <h5 class="text-white font-bold text-xl flex items-center gap-3">
                    <i class="bi bi-lightning text-2xl"></i>
                    <span>Quick Actions</span>
                </h5>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                    <a href="{{ url_for('borrowing.borrow_book') }}" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-8 py-6 rounded-xl flex flex-col items-center justify-center gap-3 hover:from-red-600 hover:to-red-700 transform transition hover:scale-105 shadow-lg">
                        <i class="bi bi-plus-circle text-4xl"></i>
                        <span class="font-bold text-lg">Borrow Book</span>
                    </a>

                    <a href="{{ url_for('students.add_student') }}" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-6 rounded-xl flex flex-col items-center justify-center gap-3 hover:from-green-600 hover:to-green-700 transform transition hover:scale-105 shadow-lg">
                        <i class="bi bi-person-plus text-4xl"></i>
                        <span class="font-bold text-lg">Add Student</span>
                    </a>

                    <a href="{{ url_for('books.add_book') }}" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-6 rounded-xl flex flex-col items-center justify-center gap-3 hover:from-blue-600 hover:to-blue-700 transform transition hover:scale-105 shadow-lg">
                        <i class="bi bi-journal-plus text-4xl"></i>
                        <span class="font-bold text-lg">Add Book</span>
                    </a>

                    <a href="{{ url_for('borrowing.list_fines') }}" class="bg-gradient-to-r from-amber-500 to-amber-600 text-white px-8 py-6 rounded-xl flex flex-col items-center justify-center gap-3 hover:from-amber-600 hover:to-amber-700 transform transition hover:scale-105 shadow-lg">
                        <i class="bi bi-cash text-4xl"></i>
                        <span class="font-bold text-lg">View Fines</span>
                    </a>
                </div>
            </div>
        </div>

        {% if current_user.role == 'admin' %}
        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200 mt-6">
            <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 px-6 py-5">
                <h5 class="text-white font-bold text-xl flex items-center gap-3">
                    <i class="bi bi-envelope text-2xl"></i>
                    <span>Email Notification System</span>
                </h5>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                        <div class="text-green-600 font-bold text-sm mb-1">Emails Sent</div>
                        <div class="text-3xl font-bold text-green-700">{{ email_stats.total_sent }}</div>
                    </div>
                    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                        <div class="text-red-600 font-bold text-sm mb-1">Failed Emails</div>
                        <div class="text-3xl font-bold text-red-700">{{ email_stats.total_failed }}</div>
                    </div>
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                        <div class="text-blue-600 font-bold text-sm mb-1">Due Reminders</div>
                        <div class="text-3xl font-bold text-blue-700">{{ email_stats.due_reminders }}</div>
                    </div>
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                        <div class="text-amber-600 font-bold text-sm mb-1">Overdue Notices</div>
                        <div class="text-3xl font-bold text-amber-700">{{ email_stats.overdue_notices }}</div>
                    </div>
                </div>

                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 mb-6">
                    <h6 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i class="bi bi-info-circle"></i> Email System Status
                    </h5>
                </div>
                <div class="p-6">
                    {% if has_gmail %}
                    <div class="bg-green-100 text-green-800 p-4 rounded-lg">
                        <strong>Mode:</strong> Gmail SMTP (Active)
                        <p class="mt-2 text-sm">✓ Emails are being sent via Gmail SMTP</p>
                        <p class="text-xs mt-1">Sending from: {{ config.get('GMAIL_USER', 'Not configured') }}</p>
                    </div>
                    {% elif has_sendgrid %}
                    <div class="bg-green-100 text-green-800 p-4 rounded-lg">
                        <strong>Mode:</strong> SendGrid API (Active)
                        <p class="mt-2 text-sm">✓ Emails are being sent via SendGrid</p>
                    </div>
                    {% else %}
                    <div class="bg-red-100 text-red-800 p-4 rounded-lg">
                        <strong>Mode:</strong> ⚠️ No Email Service Configured
                        <p class="mt-2 text-sm">Emails will NOT be sent. Please configure Gmail or SendGrid credentials in Secrets.</p>
                        <div class="mt-3 text-sm">
                            <p><strong>Gmail Setup:</strong> Add GMAIL_USER and GMAIL_APP_PASSWORD to Secrets</p>
                            <p><strong>SendGrid Setup:</strong> Add SENDGRID_API_KEY to Secrets</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="mt-4 flex gap-3 flex-wrap">
                    {% if has_email_service %}
                    <a href="{{ url_for('dashboard.test_email') }}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="bi bi-envelope-check"></i> Test Email
                    </a>
                    <a href="{{ url_for('dashboard.send_due_reminders') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="bi bi-send"></i> Send Due Reminders
                    </a>
                    <a href="{{ url_for('dashboard.send_overdue_notices_route') }}" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="bi bi-exclamation-triangle"></i> Send Overdue Notices
                    </a>
                    {% else %}
                    <div class="bg-gray-300 text-gray-600 px-4 py-2 rounded-lg cursor-not-allowed">
                        <i class="bi bi-send-slash"></i> Email functions disabled (configure credentials first)
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}